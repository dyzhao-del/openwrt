name: Build Official OpenWrt for Youhua WR1200JS (K1200JS)

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本'
        required: false
        default: 'v1.0'

env:
  REPO_URL: "https://github.com/openwrt/openwrt.git"
  REPO_BRANCH: "openwrt-24.10"
  DEVICE_NAME: "youhua_wr1200js"
  FIRMWARE_NAME: "openwrt-youhua-wr1200js"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev libncursesw5-dev libssl-dev python3 python3-pip python3-setuptools rsync unzip zlib1g-dev file wget curl upx jq subversion libxml2-dev libxml2-utils xsltproc
        echo "✅ 编译环境准备完成"
      
    - name: Clone Official OpenWrt
      run: |
        echo "正在克隆官方OpenWrt源码..."
        git clone $REPO_URL openwrt-source -b $REPO_BRANCH --depth=1
        cd openwrt-source
        echo "✅ 源码克隆完成"
        
        echo "=== 验证设备支持 ==="
        if [ -d "target/linux/ramips/mt7621" ]; then
          echo "找到 MT7621 目标平台"
          echo "搜索友华设备:"
          find target/linux/ramips -name "*.mk" -exec grep -l "wr1200js\|youhua" {} \; 2>/dev/null || echo "未找到友华设备定义"
        else
          echo "⚠️ MT7621 目录不存在"
        fi
      
    - name: Configure Build
      run: |
        cd openwrt-source
        
        echo "=== 配置编译选项 ==="
        
        # 1. 检查 scripts/config 目录结构
        echo "1. 检查 scripts/config 结构..."
        if [ -d "scripts/config" ]; then
          echo "scripts/config 是目录，包含以下文件:"
          ls -la scripts/config/
        fi
        
        # 2. 使用 echo 创建基础 .config 文件
        echo "2. 创建基础配置..."
        echo "CONFIG_TARGET_ramips=y" > .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        
        # 检查设备是否真的存在
        echo "检查 youhua_wr1200js 设备..."
        if grep -r "youhua_wr1200js" target/linux/ramips/mt7621/ 2>/dev/null; then
          echo "设备存在，使用 youhua_wr1200js"
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_youhua_wr1200js=y" >> .config
        else
          echo "设备不存在，使用 generic 设备"
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_generic=y" >> .config
        fi
        
        # 3. 运行 make defconfig 来完善配置
        echo "3. 运行 make defconfig..."
        make defconfig
        
        # 4. 使用 echo 添加其他配置选项
        echo "4. 配置其他选项..."
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_ip-full=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-tproxy=y" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7603=y" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7615e=y" >> .config
        echo "CONFIG_PACKAGE_wpad-openssl=y" >> .config
        echo "# CONFIG_PACKAGE_libselinux is not set" >> .config
        echo "# CONFIG_PACKAGE_selinux-policy is not set" >> .config
        
        # 5. 再次运行 defconfig 来清理和验证配置
        echo "5. 验证配置..."
        make defconfig
        
        echo "✅ 配置完成"
        echo "=== 配置摘要 ==="
        echo "目标平台:"
        grep "^CONFIG_TARGET" .config
        echo ""
        echo "设备选择:"
        grep "DEVICE_" .config || echo "未找到设备配置"
        echo ""
        echo "配置文件大小: $(wc -l < .config) 行"
      
    - name: Update Feeds
      run: |
        cd openwrt-source
        echo "更新feeds..."
        
        # 确保 scripts/feeds 可执行
        if [ -f "scripts/feeds" ]; then
          chmod +x scripts/feeds
        fi
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "✅ feeds更新完成"
      
    - name: Download Dependencies
      run: |
        cd openwrt-source
        echo "下载依赖文件..."
        
        # 先检查并修复权限
        find . -name "*.pl" -o -name "*.py" | xargs chmod +x 2>/dev/null || true
        
        # 单线程下载
        make download -j1 V=sc
        
        echo "✅ 依赖下载完成"
        echo "下载的文件数量:"
        ls -la dl/ | wc -l
      
    - name: Setup Swap Space
      run: |
        echo "设置交换空间..."
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "当前内存状态:"
        free -h
        echo "✅ 交换空间设置完成"
      
    - name: Build Firmware
      run: |
        cd openwrt-source
        
        echo "开始编译固件..."
        echo "开始时间: $(date)"
        echo "预计编译时间: 60-120分钟"
        
        # 创建编译日志文件
        BUILD_LOG="build_$(date +%Y%m%d_%H%M%S).log"
        
        # 阶段1: 编译工具链
        echo "阶段1: 编译工具链..."
        make tools/compile -j2 V=s 2>&1 | tee -a "$BUILD_LOG"
        
        # 阶段2: 安装工具链
        echo "阶段2: 安装工具链..."
        make toolchain/install -j2 V=s 2>&1 | tee -a "$BUILD_LOG"
        
        # 阶段3: 编译固件
        echo "阶段3: 编译固件核心..."
        make -j2 V=s 2>&1 | tee -a "$BUILD_LOG"
        
        echo "编译结束时间: $(date)"
        
        # 检查编译结果
        if [ -d "bin/targets" ]; then
          echo "✅ 编译成功！"
          echo "=== 生成的固件 ==="
          find bin/targets -type f \( -name "*.bin" -o -name "*.img*" \) -exec ls -lh {} \; 2>/dev/null || echo "未找到固件文件"
          
          # 查找友华相关固件
          echo ""
          echo "=== 查找友华相关固件 ==="
          find bin/targets -type f \( -name "*youhua*" -o -name "*wr1200*" -o -name "*k1200*" \) -exec ls -lh {} \; 2>/dev/null || echo "未找到友华特定固件"
        else
          echo "❌ 编译失败！"
          echo "=== 错误摘要 ==="
          tail -200 "$BUILD_LOG" | grep -B3 -A3 "error\|Error\|ERROR\|failed\|Failed\|undefined" | head -50
          echo "=== 完整日志文件: $BUILD_LOG ==="
          exit 1
        fi
      
    - name: Upload Firmware and Logs
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          openwrt-source/bin/targets/
          openwrt-source/.config
          openwrt-source/build_*.log
        if-no-files-found: warn
        retention-days: 7
      
    - name: Create Build Report
      if: always()
      run: |
        echo "=== 编译报告 ===" > report.txt
        echo "时间: $(date)" >> report.txt
        echo "仓库: $REPO_URL" >> report.txt
        echo "分支: $REPO_BRANCH" >> report.txt
        echo "设备: $DEVICE_NAME" >> report.txt
        echo "" >> report.txt
        
        if [ -d "openwrt-source" ]; then
          cd openwrt-source
          echo "编译状态: ${{ job.status }}" >> report.txt
          echo "" >> report.txt
          
          if [ -d "bin/targets" ]; then
            echo "✅ 编译成功" >> report.txt
            echo "" >> report.txt
            echo "生成的固件:" >> report.txt
            find bin/targets -name "*.bin" -exec echo "  - {}" \; >> report.txt 2>/dev/null || echo "  无固件文件" >> report.txt
          else
            echo "❌ 编译失败" >> report.txt
            echo "" >> report.txt
            echo "错误信息:" >> report.txt
            if [ -f "build_*.log" ]; then
              echo "详见 build_*.log 日志文件" >> report.txt
            fi
          fi
        fi
        
        echo "=== 报告结束 ===" >> report.txt
        
        # 显示报告内容
        echo "编译报告生成完成:"
        cat report.txt
        
        # 上传报告
        echo "报告已保存到 report.txt"
