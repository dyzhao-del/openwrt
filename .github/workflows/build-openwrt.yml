
name: Build Official OpenWrt for Youhua WR1200JS (K1200JS)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å›ºä»¶ç‰ˆæœ¬'
        required: false
        default: 'v1.0'

env:
  # ä½¿ç”¨å®˜æ–¹OpenWrtæºç ï¼ˆæœ€ç¨³å®šï¼‰
  REPO_URL: "https://github.com/openwrt/openwrt.git"
  REPO_BRANCH: "openwrt-24.10"
  DEVICE_NAME: "youhua_wr1200js"
  FIRMWARE_NAME: "openwrt-youhua-wr1200js"

jobs:
  build:
    runs-on: ubuntu-22.04  # ä½¿ç”¨æ›´ç¨³å®šçš„22.04
    timeout-minutes: 180   # è®¾ç½®3å°æ—¶è¶…æ—¶
    
    steps:
    # æ­¥éª¤1: è·å–ä»£ç 
    - name: Checkout
      uses: actions/checkout@v3
      
    # æ­¥éª¤2: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          curl \
          upx \
          jq
        echo "âœ… ç¼–è¯‘ç¯å¢ƒå‡†å¤‡å®Œæˆ"
      
    # æ­¥éª¤3: å…‹éš†å®˜æ–¹OpenWrtæºç 
    - name: Clone Official OpenWrt
      run: |
        echo "æ­£åœ¨å…‹éš†å®˜æ–¹OpenWrtæºç ..."
        git clone $REPO_URL openwrt-source -b $REPO_BRANCH --depth=1
        cd openwrt-source
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        
        # éªŒè¯è®¾å¤‡æ˜¯å¦æ”¯æŒ
        echo "=== éªŒè¯è®¾å¤‡æ”¯æŒ ==="
        if find target/linux/ramips -type f -exec grep -l "wr1200js" {} \; 2>/dev/null; then
          echo "âœ… å®˜æ–¹æ”¯æŒ YouHua WR1200JS"
        else
          echo "âš ï¸ åœ¨å®˜æ–¹æºç ä¸­æœç´¢è®¾å¤‡..."
          grep -r "wr1200\|youhua" target/linux/ramips/ 2>/dev/null || echo "æœªæ‰¾åˆ°è®¾å¤‡ä¿¡æ¯"
        fi
      
    # æ­¥éª¤4: é…ç½®ç¼–è¯‘é€‰é¡¹ï¼ˆæ­£ç¡®çš„æ–¹æ³•ï¼‰
    - name: Configure Build
      run: |
        cd openwrt-source
        
        echo "å¼€å§‹é…ç½®ç¼–è¯‘é€‰é¡¹..."
        
        # æ–¹æ³•1: ä½¿ç”¨defconfigç”ŸæˆåŸºç¡€é…ç½®
        echo "1. ç”ŸæˆåŸºç¡€é…ç½®..."
        
        # ä½¿ç”¨echoåˆ›å»ºåŸºç¡€é…ç½®æ–‡ä»¶
        echo "CONFIG_TARGET_ramips=y" > .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        
        # ç”Ÿæˆé»˜è®¤é…ç½®
        make defconfig
        
        echo "2. é€‰æ‹©å‹åWR1200JSè®¾å¤‡..."
        # ä½¿ç”¨äº¤äº’å¼menuconfigï¼ˆé€šè¿‡è„šæœ¬è‡ªåŠ¨åŒ–ï¼‰
        # é¦–å…ˆæŸ¥çœ‹å¯ç”¨çš„è®¾å¤‡
        echo "å¯ç”¨çš„MT7621è®¾å¤‡:"
        grep "DEVICE_.*=" target/linux/ramips/mt7621/profiles/* 2>/dev/null | grep -i "youhua\|wr1200" || true
        
        # è®¾ç½®è®¾å¤‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if grep -q "youhua_wr1200js" target/linux/ramips/mt7621/profiles/* 2>/dev/null; then
          echo "è®¾ç½®è®¾å¤‡: youhua_wr1200js"
          ./scripts/config --set-val CONFIG_TARGET_ramips_mt7621_DEVICE_youhua_wr1200js y
        else
          echo "âš ï¸ æœªæ‰¾åˆ°ç¡®åˆ‡è®¾å¤‡åï¼Œä½¿ç”¨genericæµ‹è¯•"
          ./scripts/config --set-val CONFIG_TARGET_ramips_mt7621_DEVICE_generic y
        fi
        
        echo "3. é…ç½®åŸºç¡€é€‰é¡¹..."
        # è®¾ç½®é•œåƒå¤§å°ï¼ˆ16MBé—ªå­˜ï¼Œç•™å‡ºé…ç½®ç©ºé—´ï¼‰
        ./scripts/config --set-str CONFIG_TARGET_ROOTFS_PARTSIZE "128"
        
        # å¯ç”¨å¿…è¦åŠŸèƒ½
        ./scripts/config --enable TARGET_ROOTFS_SQUASHFS
        ./scripts/config --enable TARGET_ROOTFS_TARGZ
        
        # å¯ç”¨LuCI
        ./scripts/config --enable PACKAGE_luci
        ./scripts/config --enable PACKAGE_luci-compat
        ./scripts/config --enable PACKAGE_luci-i18n-base-zh-cn
        
        # å¯ç”¨åŸºç¡€å·¥å…·
        ./scripts/config --enable PACKAGE_ip-full
        ./scripts/config --enable PACKAGE_iptables-mod-tproxy
        
        # å¯ç”¨æ— çº¿é©±åŠ¨ï¼ˆå‹åK1200JSéœ€è¦ï¼‰
        ./scripts/config --enable PACKAGE_kmod-mt7603
        ./scripts/config --enable PACKAGE_kmod-mt7615e
        ./scripts/config --enable PACKAGE_wpad-openssl
        
        # ç¦ç”¨å¯èƒ½æœ‰é—®é¢˜çš„åŒ…
        ./scripts/config --disable PACKAGE_libselinux
        ./scripts/config --disable PACKAGE_selinux-policy
        
        echo "4. ç”Ÿæˆæœ€ç»ˆé…ç½®..."
        make defconfig
        
        echo "âœ… é…ç½®å®Œæˆ"
        echo "=== é…ç½®æ‘˜è¦ ==="
        echo "ç›®æ ‡å¹³å°:"
        grep "^CONFIG_TARGET" .config
        echo ""
        echo "è®¾å¤‡é€‰æ‹©:"
        grep "DEVICE_" .config || echo "æœªæ‰¾åˆ°è®¾å¤‡é…ç½®"
        echo ""
        echo "å¯ç”¨çš„åŒ…:"
        grep "^CONFIG_PACKAGE.*=y" .config | head -20
      
    # æ­¥éª¤5: æ›´æ–°feedsï¼ˆå®˜æ–¹æºï¼‰
    - name: Update Feeds
      run: |
        cd openwrt-source
        echo "æ›´æ–°feeds..."
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "âœ… feedsæ›´æ–°å®Œæˆ"
      
    # æ­¥éª¤6: ä¸‹è½½ä¾èµ–
    - name: Download Dependencies
      run: |
        cd openwrt-source
        echo "ä¸‹è½½ä¾èµ–æ–‡ä»¶..."
        
        # å•çº¿ç¨‹ä¸‹è½½é¿å…é—®é¢˜
        make download -j1
        
        echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"
        echo "æ£€æŸ¥å…³é”®æ–‡ä»¶:"
        ls -la dl/ | head -10
      
    # æ­¥éª¤7: è®¾ç½®äº¤æ¢ç©ºé—´ï¼ˆé¿å…å†…å­˜ä¸è¶³ï¼‰
    - name: Setup Swap Space
      run: |
        echo "è®¾ç½®äº¤æ¢ç©ºé—´..."
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "å½“å‰å†…å­˜çŠ¶æ€:"
        free -h
        echo "âœ… äº¤æ¢ç©ºé—´è®¾ç½®å®Œæˆ"
      
    # æ­¥éª¤8: ç¼–è¯‘å›ºä»¶ï¼ˆåˆ†é˜¶æ®µï¼Œå•çº¿ç¨‹ç¨³å®šï¼‰
    - name: Build Firmware
      run: |
        cd openwrt-source
        
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "é¢„è®¡æ—¶é—´: 60-120åˆ†é’Ÿ"
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
        BUILD_LOG="build_$(date +%Y%m%d_%H%M%S).log"
        
        # é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾ï¼ˆå¿…é¡»ï¼‰
        echo "é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾..."
        make tools/compile -j1 V=s 2>&1 | tee -a "$BUILD_LOG"
        
        # é˜¶æ®µ2: ç¼–è¯‘å·¥å…·é“¾å®‰è£…
        echo "é˜¶æ®µ2: å®‰è£…å·¥å…·é“¾..."
        make toolchain/install -j1 V=s 2>&1 | tee -a "$BUILD_LOG"
        
        # é˜¶æ®µ3: ç¼–è¯‘å›ºä»¶æ ¸å¿ƒ
        echo "é˜¶æ®µ3: ç¼–è¯‘å›ºä»¶æ ¸å¿ƒ..."
        make -j1 V=s 2>&1 | tee -a "$BUILD_LOG"
        
        echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -d bin/targets ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "=== ç”Ÿæˆçš„å›ºä»¶ ==="
          find bin/targets -type f \( -name "*.bin" -o -name "*.img*" \) | xargs ls -lh 2>/dev/null | head -10
          
          # ç‰¹åˆ«æŸ¥æ‰¾å‹åç›¸å…³å›ºä»¶
          echo ""
          echo "=== æŸ¥æ‰¾å‹åç›¸å…³å›ºä»¶ ==="
          find bin/targets -type f \( -name "*youhua*" -o -name "*wr1200*" -o -name "*k1200*" \) | xargs ls -lh 2>/dev/null || echo "æœªæ‰¾åˆ°å‹åç‰¹å®šå›ºä»¶"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
          echo "=== é”™è¯¯æ‘˜è¦ ==="
          tail -200 "$BUILD_LOG" | grep -B3 -A3 "error\|Error\|ERROR\|failed\|Failed\|undefined" | head -50
          exit 1
        fi
      
    # æ­¥éª¤9: å›ºä»¶æ·±åº¦åˆ†æ
    - name: Analyze Firmware
      if: success()
      run: |
        cd openwrt-source
        
        echo "=== å›ºä»¶æ·±åº¦åˆ†æ ==="
        
        # æ‰¾åˆ°å›ºä»¶æ–‡ä»¶
        FIRMWARE=$(find bin/targets -name "*.bin" | head -1)
        
        if [ -f "$FIRMWARE" ]; then
          echo "åˆ†æå›ºä»¶: $(basename $FIRMWARE)"
          echo "å¤§å°: $(du -h "$FIRMWARE" | cut -f1)"
          echo ""
          
          # 1. æ£€æŸ¥è®¾å¤‡å…¼å®¹æ€§
          echo "1. è®¾å¤‡å…¼å®¹æ€§æ£€æŸ¥:"
          if strings "$FIRMWARE" | grep -qi "youhua.*wr1200js\|wr1200js.*youhua"; then
            echo "   âœ… åŒ…å«æ­£ç¡®çš„è®¾å¤‡æ ‘æ ‡è¯†"
            strings "$FIRMWARE" | grep -i "youhua.*wr1200js\|wr1200js.*youhua" | head -3
          else
            echo "   âŒ æœªæ‰¾åˆ°æ­£ç¡®çš„è®¾å¤‡æ ‘æ ‡è¯†"
            echo "   æœç´¢åˆ°çš„ç›¸å…³å­—ç¬¦ä¸²:"
            strings "$FIRMWARE" | grep -i "youhua\|wr1200\|k1200\|mt7621" | head -10
          fi
          
          echo ""
          # 2. æ£€æŸ¥é©±åŠ¨æ”¯æŒ
          echo "2. é©±åŠ¨æ”¯æŒæ£€æŸ¥:"
          for driver in "mt7621" "mt7603" "mt761[25]"; do
            if strings "$FIRMWARE" | grep -qi "$driver"; then
              echo "   âœ… åŒ…å« $driver é©±åŠ¨"
            else
              echo "   âŒ æœªæ‰¾åˆ° $driver é©±åŠ¨"
            fi
          done
          
          echo ""
          # 3. å›ºä»¶ç±»å‹éªŒè¯
          echo "3. å›ºä»¶ç±»å‹éªŒè¯:"
          file "$FIRMWARE"
          
          echo ""
          # 4. é£é™©è¯„ä¼°
          echo "4. åˆ·æœºé£é™©è¯„ä¼°:"
          SCORE=0
          
          if strings "$FIRMWARE" | grep -qi "youhua.*wr1200js"; then
            echo "   âœ… è®¾å¤‡æ ‡è¯†æ­£ç¡® (+30åˆ†)"
            SCORE=$((SCORE + 30))
          fi
          
          if strings "$FIRMWARE" | grep -qi "mt7621"; then
            echo "   âœ… åŒ…å«MT7621é©±åŠ¨ (+20åˆ†)"
            SCORE=$((SCORE + 20))
          fi
          
          if strings "$FIRMWARE" | grep -qi "mt7603"; then
            echo "   âœ… åŒ…å«MT7603é©±åŠ¨ (+20åˆ†)"
            SCORE=$((SCORE + 20))
          fi
          
          if strings "$FIRMWARE" | grep -qi "mt761[25]"; then
            echo "   âœ… åŒ…å«5GHzæ— çº¿é©±åŠ¨ (+20åˆ†)"
            SCORE=$((SCORE + 20))
          fi
          
          SIZE_MB=$(($(stat -c%s "$FIRMWARE") / 1024 / 1024))
          if [ $SIZE_MB -lt 15 ]; then
            echo "   âœ… å›ºä»¶å¤§å°åˆé€‚ ($SIZE_MB MB) (+10åˆ†)"
            SCORE=$((SCORE + 10))
          else
            echo "   âš ï¸ å›ºä»¶è¾ƒå¤§ ($SIZE_MB MB)"
          fi
          
          echo ""
          echo "   ğŸ¯ å…¼å®¹æ€§æ€»åˆ†: $SCORE/100"
          
          if [ $SCORE -ge 90 ]; then
            echo "   ğŸ‰ ä½é£é™© - å¯ä»¥å°è¯•åˆ·æœº"
          elif [ $SCORE -ge 70 ]; then
            echo "   âš ï¸ ä¸­ç­‰é£é™© - å»ºè®®è¿›ä¸€æ­¥éªŒè¯"
          else
            echo "   âŒ é«˜é£é™© - ä¸å»ºè®®åˆ·æœº"
          fi
        else
          echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
        fi
      
    # æ­¥éª¤10: ä¸Šä¼ ç¼–è¯‘ç»“æœ
    - name: Upload Firmware and Logs
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          openwrt-source/bin/targets/ramips/mt7621/*.bin
          openwrt-source/bin/targets/ramips/mt7621/*.img*
          openwrt-source/bin/targets/ramips/mt7621/*.gz
          openwrt-source/.config
          openwrt-source/build_*.log
        if-no-files-found: warn
        retention-days: 7
      
    # æ­¥éª¤11: åˆ›å»ºè¯¦ç»†æŠ¥å‘Š
    - name: Create Build Report
      if: always()
      run: |
        echo "=== ç¼–è¯‘æŠ¥å‘Š ===" > report.txt
        echo "æ—¶é—´: $(date)" >> report.txt
        echo "ä»“åº“: $REPO_URL" >> report.txt
        echo "åˆ†æ”¯: $REPO_BRANCH" >> report.txt
        echo "è®¾å¤‡: $DEVICE_NAME" >> report.txt
        echo "" >> report.txt
        
        cd openwrt-source 2>/dev/null || exit 0
        
        echo "ç¼–è¯‘çŠ¶æ€: ${{ job.status }}" >> report.txt
        echo "" >> report.txt
        
        if [ -d bin/targets ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ" >> report.txt
          echo "" >> report.txt
          echo "ç”Ÿæˆçš„å›ºä»¶:" >> report.txt
          find bin/targets -name "*.bin" -exec echo "  - {}" \; >> report.txt 2>/dev/null || true
          echo "" >> report.txt
          echo "è¯¦ç»†æ—¥å¿—è§ build_*.log æ–‡ä»¶" >> report.txt
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥" >> report.txt
          echo "" >> report.txt
          echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—è·å–æ›´å¤šä¿¡æ¯" >> report.txt
        fi
        
        echo "=== æŠ¥å‘Šç»“æŸ ===" >> report.txt
        
        # ä¸Šä¼ æŠ¥å‘Š
        echo "ç”ŸæˆæŠ¥å‘Šå®Œæˆ"
        ls -lh report.txt
