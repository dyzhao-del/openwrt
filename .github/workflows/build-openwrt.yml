name: Build OpenWrt for Youhua K1200JS

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本'
        required: false
        default: 'v1.0'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 18 * * *'

env:
  REPO_URL: "https://bgithub.xyz/coolsnowwolf/openwrt.git"
  REPO_BRANCH: "main"
  FIRMWARE_NAME: "openwrt-ramips-mt7621-yh_k1200js"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: true
      
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-full \
          python3-pip \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          xsltproc \
          zlib1g-dev \
          wget
        echo "环境设置完成"
      
    - name: Clone OpenWrt Source
      run: |
        echo "正在克隆源码..."
        git clone $REPO_URL openwrt-source -b $REPO_BRANCH --depth=1
        cd openwrt-source
        echo "源码克隆完成"
        
        if [ -f ../.config ]; then
          echo "使用自定义配置文件"
          cp ../.config .config
        fi
        
        if [ -f ../feeds.conf.default ]; then
          echo "使用自定义feeds配置"
          cp ../feeds.conf.default feeds.conf.default
        fi
      
    - name: Update and Install Feeds
      run: |
        cd openwrt-source
        echo "更新feeds..."
        ./scripts/feeds update -a
        
        echo "安装feeds..."
        ./scripts/feeds install -a
        
        ./scripts/feeds install v2ray-core
        ./scripts/feeds install v2ray-plugin
        ./scripts/feeds install luci-app-v2ray-server
        echo "Feeds安装完成"
      
    - name: Generate Config
      run: |
        cd openwrt-source
        echo "生成配置文件..."
        make defconfig
        echo "配置生成完成"
        
        echo "=== 当前配置摘要 ==="
        grep "CONFIG_TARGET" .config
        grep "CONFIG_PACKAGE_v2ray" .config
        echo "==================="
    
    - name: Run Custom Script
      run: |
        cd openwrt-source
        if [ -f ../diy-script.sh ]; then
          echo "运行自定义脚本..."
          chmod +x ../diy-script.sh
          ../diy-script.sh
          echo "自定义脚本执行完成"
        else
          echo "未找到自定义脚本，跳过"
        fi
      
    - name: Download Dependencies
      run: |
        cd openwrt-source
        echo "下载依赖文件..."
        make download -j$(nproc) || make download -j1
        echo "依赖下载完成"
        
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
      
    - name: Build Firmware
      run: |
        cd openwrt-source
        echo "开始编译固件..."
        echo "编译时间可能较长，请耐心等待..."
        
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
        if [ -d bin/targets ]; then
          echo "编译成功！"
          echo "生成的固件："
          find bin/targets -name "*.bin" -o -name "*.img.gz"
        else
          echo "编译失败！"
          echo "最后100行日志："
          tail -100 build.log
          exit 1
        fi
      
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          openwrt-source/bin/targets/ramips/mt7621/*.bin
          openwrt-source/bin/targets/ramips/mt7621/*.img.gz
          openwrt-source/.config
        retention-days: 7
      
    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: |
          openwrt-source/build.log
        retention-days: 7
      
    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: k1200js-${{ github.run_number }}
        name: 友华K1200JS固件
        body: |
          ## 友华K1200JS OpenWrt固件
          
          **编译信息：**
          - 编译时间: ${{ github.event.head_commit.timestamp || github.run_started_at }}
          - 源码仓库: ${{ env.REPO_URL }}
          - 包含插件: V2ray核心、V2ray插件、LuCI界面
          
          **刷机说明：**
          1. 进入路由器原厂固件升级页面
          2. 选择下载的固件文件（factory.bin）
          3. 等待刷机完成（约3-5分钟）
          4. 路由器会自动重启
          
          **默认信息：**
          - 管理地址: 192.168.1.1
          - 用户名: root
          - 密码: password
          
          **注意事项：**
          - 刷机有风险，请提前备份配置
          - 确保路由器型号为友华K1200JS
        draft: false
        prerelease: false
        files: |
          openwrt-source/bin/targets/ramips/mt7621/*.bin
          openwrt-source/bin/targets/ramips/mt7621/*.img.gz
