name: Build OpenWrt for Youhua K1200JS

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本'
        required: false
        default: 'v1.0'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 18 * * *'

env:
  # 使用Lean's LEDE源码
  REPO_URL: "https://github.com/coolsnowwolf/lede.git"
  REPO_BRANCH: "master"
  FIRMWARE_NAME: "openwrt-youhua-k1200js"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 步骤1: 获取代码
    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: true
      
    # 步骤2: 初始化环境
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-full \
          python3-pip \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          xsltproc \
          zlib1g-dev \
          wget \
          gcc-multilib \
          flex \
          bison
        echo "✅ 环境设置完成"
      
    # 步骤3: 克隆OpenWrt源码
    - name: Clone OpenWrt Source
      run: |
        echo "正在克隆源码..."
        git clone $REPO_URL openwrt-source -b $REPO_BRANCH --depth=1
        echo "✅ 源码克隆完成"
      
    # 步骤4: 应用已验证的最小配置
    - name: Apply Minimal Config
      run: |
        echo "应用友华K1200JS专用配置..."
        
        # 创建配置文件 - 直接使用路径
        {
          echo "# 友华K1200JS专用配置"
          echo "CONFIG_TARGET_ramips=y"
          echo "CONFIG_TARGET_ramips_mt7621=y"
          echo "# CONFIG_TARGET_ramips_mt7621_DEVICE_generic is not set"
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_youhua_k1200js=y"
          echo ""
          echo "# 基础设置"
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128"
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
          echo "CONFIG_TARGET_ROOTFS_TARGZ=y"
        } > openwrt-source/.config
        
        echo "✅ 配置文件已应用"
        echo "配置内容预览："
        head -20 openwrt-source/.config
      
    # 步骤5: 更新和安装feeds
    - name: Update and Install Feeds
      run: |
        echo "进入openwrt-source目录..."
        cd openwrt-source
        
        echo "更新feeds..."
        
        # 配置feeds
        echo "src-git packages https://github.com/coolsnowwolf/packages.git" > feeds.conf.default
        echo "src-git luci https://github.com/coolsnowwolf/luci.git" >> feeds.conf.default
        echo "src-git routing https://github.com/coolsnowwolf/routing.git" >> feeds.conf.default
        echo "src-git telephony https://github.com/coolsnowwolf/telephony.git" >> feeds.conf.default
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "✅ Feeds安装完成"
      
    # 步骤6: 生成最终配置
    - name: Generate Final Config
      run: |
        echo "进入openwrt-source目录..."
        cd openwrt-source
        
        echo "生成最终配置..."
        make defconfig
        
        echo "✅ 配置生成完成"
        echo "当前配置摘要："
        grep "^CONFIG_TARGET\|^CONFIG_PACKAGE" .config | head -10
      
    # 步骤7: 下载依赖
    - name: Download Dependencies
      run: |
        echo "进入openwrt-source目录..."
        cd openwrt-source
        
        echo "下载依赖文件..."
        make download -j1
        
        echo "依赖下载完成"
        echo "dl目录大小："
        du -sh dl/ 2>/dev/null || echo "dl目录不存在"
      
    # 步骤8: 设置交换空间
    - name: Setup Swap Space
      run: |
        echo "设置交换空间..."
        sudo fallocate -l 2G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "✅ 交换空间设置完成"
        echo "当前内存状态："
        free -h
      
    # 步骤9: 编译固件
    - name: Build Firmware
      run: |
        echo "进入openwrt-source目录..."
        cd openwrt-source
        
        echo "开始编译固件..."
        make -j1 V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ -d bin/targets ]; then
          echo "✅ 编译成功！"
          echo "=== 生成的固件文件 ==="
          find bin/targets -type f \( -name "*.bin" -o -name "*.img*" \) 2>/dev/null | xargs ls -lh 2>/dev/null || echo "未找到固件文件"
          echo "======================"
        else
          echo "❌ 编译失败！"
          echo "=== 最后50行错误信息 ==="
          tail -50 build.log
          echo "========================"
          exit 1
        fi
      
    # 步骤10: 上传固件
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          openwrt-source/bin/**/*.bin
          openwrt-source/bin/**/*.img*
          openwrt-source/bin/**/*.gz
        if-no-files-found: warn
        retention-days: 7
