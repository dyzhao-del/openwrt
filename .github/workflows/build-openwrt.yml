name: Build OpenWrt for Youhua K1200JS

on:
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本'
        required: false
        default: 'v1.0'
  push:
    branches: [ main ]
  schedule:
    - cron: '0 18 * * *'

env:
  REPO_URL: "https://github.com/coolsnowwolf/lede.git"
  REPO_BRANCH: "master"
  FIRMWARE_NAME: "openwrt-youhua-k1200js"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 步骤1: 获取代码
    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: true
      
    # 步骤2: 初始化环境
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-full \
          python3-pip \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          xsltproc \
          zlib1g-dev \
          wget \
          gcc-multilib \
          flex \
          bison \
          libpcre2-dev
        echo "✅ 环境设置完成"
      
    # 步骤3: 克隆OpenWrt源码
    - name: Clone OpenWrt Source
      run: |
        echo "正在克隆源码..."
        echo "源码地址: $REPO_URL"
        git clone $REPO_URL openwrt-source -b $REPO_BRANCH --depth=1
        if [ $? -eq 0 ]; then
          echo "✅ 源码克隆完成"
          echo "源码目录大小:"
          du -sh openwrt-source
        else
          echo "❌ 源码克隆失败"
          exit 1
        fi
      
    # 步骤3.5: 搜索友华设备定义
    - name: Find Youhua Device Definition
      run: |
        echo "搜索友华K1200JS设备定义..."
        cd openwrt-source
        
        echo "=== ramips目录结构 ==="
        ls -la target/linux/ramips/ 2>/dev/null || echo "ramips目录不存在"
        
        echo ""
        echo "=== 搜索MT7621设备 ==="
        MT7621_FILES=$(find target/linux/ramips -type f -name "*.mk" 2>/dev/null | xargs grep -l "7621" 2>/dev/null || true)
        
        if [ -n "$MT7621_FILES" ]; then
          echo "找到MT7621相关文件:"
          echo "$MT7621_FILES"
          
          echo ""
          echo "=== 搜索友华设备 ==="
          for file in $MT7621_FILES; do
            if grep -q -i "youhua\|k1200" "$file" 2>/dev/null; then
              echo "找到友华设备定义在: $file"
              grep -n -i "youhua\|k1200" "$file"
              DEVICE_FILE="$file"
            fi
          done
          
          if [ -n "$DEVICE_FILE" ]; then
            echo ""
            echo "=== 提取设备标识 ==="
            grep "define Device/" "$DEVICE_FILE" | grep -i "youhua\|k1200"
          else
            echo "未找到友华设备定义"
          fi
        else
          echo "未找到MT7621相关文件"
        fi
        
        echo ""
        echo "=== 所有MT7621设备列表 ==="
        if [ -f "target/linux/ramips/image/mt7621.mk" ]; then
          grep "define Device/" target/linux/ramips/image/mt7621.mk | sort
          echo "设备总数: $(grep "define Device/" target/linux/ramips/image/mt7621.mk | wc -l)"
        else
          echo "mt7621.mk文件不存在"
        fi
        
        echo "youhua_k1200js" > /tmp/device_options.txt
        echo "youhua,k1200js" >> /tmp/device_options.txt
        echo "k1200js" >> /tmp/device_options.txt
        echo "generic" >> /tmp/device_options.txt
      
    # 步骤4: 应用配置
    - name: Apply Config with Device Detection
      run: |
        echo "应用友华K1200JS配置..."
        cd openwrt-source
        
        DEVICE_ID="generic"
        DEVICE_FOUND=false
        
        if [ -f /tmp/device_options.txt ]; then
          while IFS= read -r option; do
            if find target/linux/ramips -name "*.mk" -type f 2>/dev/null | xargs grep -q "define Device/.*$option" 2>/dev/null; then
              DEVICE_ID="$option"
              DEVICE_FOUND=true
              echo "✅ 找到设备标识: $DEVICE_ID"
              break
            fi
          done < /tmp/device_options.txt
        fi
        
        if [ "$DEVICE_FOUND" = false ]; then
          echo "⚠️ 未找到友华设备标识，使用 generic"
        fi
        
        > .config
        
        {
          echo "# 友华K1200JS专用配置"
          echo "# 设备标识: $DEVICE_ID"
          echo "CONFIG_TARGET_ramips=y"
          echo "CONFIG_TARGET_ramips_mt7621=y"
        } >> .config
        
        if [ "$DEVICE_ID" = "generic" ]; then
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_generic=y" >> .config
        else
          CLEAN_DEVICE=$(echo "$DEVICE_ID" | sed 's/,/_/g')
          echo "# CONFIG_TARGET_ramips_mt7621_DEVICE_generic is not set" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_${CLEAN_DEVICE}=y" >> .config
        fi
        
        {
          echo ""
          echo "# 基础设置"
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128"
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
          echo "CONFIG_TARGET_ROOTFS_TARGZ=y"
          echo ""
          echo "# 必要的基础包"
          echo "CONFIG_PACKAGE_luci=y"
          echo "CONFIG_PACKAGE_luci-compat=y"
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y"
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y"
          echo ""
          echo "# 无线驱动"
          echo "CONFIG_PACKAGE_kmod-mt7603=y"
          echo "CONFIG_PACKAGE_kmod-mt76x2e=y"
          echo "CONFIG_PACKAGE_wpad-openssl=y"
          echo "CONFIG_PACKAGE_hostapd-common=y"
          echo ""
          echo "# 网络工具"
          echo "CONFIG_PACKAGE_ip-full=y"
          echo "CONFIG_PACKAGE_iptables-mod-tproxy=y"
          echo "CONFIG_PACKAGE_dnsmasq-full=y"
          echo ""
          echo "# 存储支持"
          echo "CONFIG_PACKAGE_kmod-usb-storage=y"
          echo "CONFIG_PACKAGE_kmod-fs-ext4=y"
          echo "CONFIG_PACKAGE_kmod-fs-vfat=y"
          echo ""
          echo "# 命令行工具"
          echo "CONFIG_PACKAGE_bash=y"
          echo "CONFIG_PACKAGE_nano=y"
          echo "CONFIG_PACKAGE_curl=y"
          echo "CONFIG_PACKAGE_wget=y"
        } >> .config
        
        echo "✅ 配置文件已应用"
      
    # 步骤5: 更新和安装feeds
    - name: Update and Install Feeds
      run: |
        cd openwrt-source
        echo "更新feeds..."
        
        {
          echo "src-git packages https://github.com/coolsnowwolf/packages.git"
          echo "src-git luci https://github.com/coolsnowwolf/luci.git"
          echo "src-git routing https://github.com/coolsnowwolf/routing.git"
          echo "src-git telephony https://github.com/coolsnowwolf/telephony.git"
        } > feeds.conf.default
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install luci
        ./scripts/feeds install luci-i18n-base-zh-cn
        ./scripts/feeds install kmod-mt7603
        ./scripts/feeds install kmod-mt76x2e
        
        echo "✅ Feeds安装完成"
      
    # 步骤6: 生成最终配置
    - name: Generate Final Config
      run: |
        cd openwrt-source
        echo "生成最终配置..."
        
        make defconfig
        echo "✅ 配置生成完成"
      
    # 步骤7: 下载依赖
    - name: Download Dependencies
      run: |
        cd openwrt-source
        echo "下载依赖文件..."
        
        make download -j1
        echo "✅ 依赖下载完成"
      
    # 步骤8: 设置交换空间
    - name: Setup Swap Space
      run: |
        echo "设置交换空间..."
        
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "✅ 交换空间设置完成"
        free -h
      
    # 步骤9: 编译固件
    - name: Build Firmware
      timeout-minutes: 180
      run: |
        cd openwrt-source
        echo "开始编译固件..."
        echo "开始时间: $(date)"
        
        echo "使用2线程编译..."
        make -j2 V=s 2>&1 | tee build.log
        
        echo "结束时间: $(date)"
        
        if [ -d bin/targets/ramips/mt7621 ]; then
          echo "✅ 编译成功！"
          echo "生成的固件:"
          ls -lh bin/targets/ramips/mt7621/*.bin 2>/dev/null || ls -lh bin/targets/ramips/mt7621/* 2>/dev/null || echo "查看bin/targets/ramips/mt7621目录"
        else
          echo "❌ 编译失败！"
          tail -50 build.log
          exit 1
        fi
      
    # 步骤10: 创建README文件（简化版）
    - name: Create Readme File
      if: success()
      run: |
        echo "创建刷机说明..."
        
        # 使用简单的echo命令创建README，避免heredoc问题
        > openwrt-source/README-flash.md
        
        echo "# 友华K1200JS OpenWrt固件刷机说明" >> openwrt-source/README-flash.md
        echo "" >> openwrt-source/README-flash.md
        echo "## 固件信息" >> openwrt-source/README-flash.md
        echo "- 设备: 友华K1200JS (MT7621 + MT7603 + MT7612E)" >> openwrt-source/README-flash.md
        echo "- 源码: Lean's LEDE" >> openwrt-source/README-flash.md
        echo "- 编译时间: $(date)" >> openwrt-source/README-flash.md
        echo "- 包含功能: LuCI管理界面、基础无线驱动、USB存储支持" >> openwrt-source/README-flash.md
        echo "" >> openwrt-source/README-flash.md
        echo "## 刷机步骤" >> openwrt-source/README-flash.md
        echo "" >> openwrt-source/README-flash.md
        echo "### 方法1: 原厂固件升级" >> openwrt-source/README-flash.md
        echo "1. 进入原厂管理界面 (通常 192.168.1.1)" >> openwrt-source/README-flash.md
        echo "2. 找到固件升级页面" >> openwrt-source/README-flash.md
        echo "3. 选择 factory.bin 文件" >> openwrt-source/README-flash.md
        echo "4. 点击升级，等待完成" >> openwrt-source/README-flash.md
        echo "" >> openwrt-source/README-flash.md
        echo "### 方法2: OpenWrt内升级" >> openwrt-source/README-flash.md
        echo "1. 登录OpenWrt管理界面 (192.168.1.1)" >> openwrt-source/README-flash.md
        echo "2. 进入 系统 -> 备份/升级" >> openwrt-source/README-flash.md
        echo "3. 选择 sysupgrade.bin 文件" >> openwrt-source/README-flash.md
        echo "4. 点击刷写固件" >> openwrt-source/README-flash.md
        echo "" >> openwrt-source/README-flash.md
        echo "## 默认设置" >> openwrt-source/README-flash.md
        echo "- 管理地址: 192.168.1.1" >> openwrt-source/README-flash.md
        echo "- 用户名: root" >> openwrt-source/README-flash.md
        echo "- 密码: password" >> openwrt-source/README-flash.md
        echo "" >> openwrt-source/README-flash.md
        echo "## 注意事项" >> openwrt-source/README-flash.md
        echo "1. 刷机前备份原厂固件" >> openwrt-source/README-flash.md
        echo "2. 确保电源稳定" >> openwrt-source/README-flash.md
        echo "3. 首次启动可能需要几分钟" >> openwrt-source/README-flash.md
        
        echo "✅ 刷机说明已创建"
      
    # 步骤11: 上传固件
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: |
          openwrt-source/bin/targets/ramips/mt7621/
          openwrt-source/README-flash.md
        if-no-files-found: error
        retention-days: 30
      
    # 步骤12: 成功通知
    - name: Success Notification
      if: success()
      run: |
        echo "🎉 编译成功完成！"
        echo "固件文件在Artifacts中"
